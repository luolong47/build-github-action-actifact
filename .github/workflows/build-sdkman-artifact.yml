name: 构建SDKMAN构建物 (Linux ARM64)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SDKMAN_DIR: /opt/sdkman
      JAVA_HOME: /opt/sdkman/candidates/java/current
      MAVEN_HOME: /opt/sdkman/candidates/maven/current
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置QEMU模拟器用于ARM64
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64
        
    - name: 设置Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: 创建构建目录
      run: |
        mkdir -p ./build-artifact
        mkdir -p ./scripts
        
    - name: 创建SDKMAN安装脚本
      run: |
        cat > ./scripts/install-sdkman.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "开始安装SDKMAN..."
        
        # 安装必要的依赖
        apt-get update
        apt-get install -y curl zip unzip tar wget
        
        # 安装SDKMAN
        export SDKMAN_DIR="${SDKMAN_DIR:-$HOME/.sdkman}"
        
        if [ ! -d "$SDKMAN_DIR" ]; then
          echo "正在安装SDKMAN到 $SDKMAN_DIR"
          curl -s "https://get.sdkman.io" | bash
        else
          echo "SDKMAN已存在于 $SDKMAN_DIR"
        fi
        
        # 初始化SDKMAN
        source "$SDKMAN_DIR/bin/sdkman-init.sh"
        
        # 配置SDKMAN
        sdk selfupdate force
        
        echo "SDKMAN安装完成"
        EOF
        
        chmod +x ./scripts/install-sdkman.sh
        
    - name: 创建Java和Maven安装脚本
      run: |
        cat > ./scripts/install-java-maven.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "开始安装JDK21和Maven..."
        
        # 初始化SDKMAN
        source "${SDKMAN_DIR:-$HOME/.sdkman}/bin/sdkman-init.sh"
        
        # 安装JDK21
        echo "正在安装JDK21..."
        JAVA_VERSION=$(sdk list java | grep -E "21\..*-" | grep -E "(adpt|tm|open)" | head -1 | awk '{print $NF}')
        sdk install java $JAVA_VERSION
        sdk default java $JAVA_VERSION
        
        # 安装最新版Maven
        echo "正在安装Maven..."
        MAVEN_VERSION=$(sdk list maven | grep -E " [0-9]+\.[0-9]+\.[0-9]+" | tail -1 | awk '{print $NF}')
        sdk install maven $MAVEN_VERSION
        sdk default maven $MAVEN_VERSION
        
        # 验证安装
        echo "验证安装..."
        java -version
        mvn -version
        
        echo "JDK21和Maven安装完成"
        EOF
        
        chmod +x ./scripts/install-java-maven.sh
        
    - name: 创建打包脚本
      run: |
        cat > ./scripts/package-artifact.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "开始打包SDKMAN构建物..."
        
        # 初始化SDKMAN
        source "${SDKMAN_DIR:-$HOME/.sdkman}/bin/sdkman-init.sh"
        
        # 创建打包目录
        PACKAGE_DIR="./build-artifact/sdkman-java21-maven-linux-arm64"
        mkdir -p "$PACKAGE_DIR"
        
        # 复制SDKMAN安装
        cp -r "${SDKMAN_DIR:-$HOME/.sdkman}" "$PACKAGE_DIR/sdkman"
        
        # 创建环境配置脚本
        cat > "$PACKAGE_DIR/setup-env.sh" << 'ENVEOF'
        #!/bin/bash
        # SDKMAN环境配置脚本
        export SDKMAN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/sdkman"
        export PATH="$SDKMAN_DIR/bin:$SDKMAN_DIR/candidates/java/current/bin:$SDKMAN_DIR/candidates/maven/current/bin:$PATH"
        export JAVA_HOME="$SDKMAN_DIR/candidates/java/current"
        export MAVEN_HOME="$SDKMAN_DIR/candidates/maven/current"
        
        # 初始化SDKMAN
        source "$SDKMAN_DIR/bin/sdkman-init.sh"
        
        echo "SDKMAN环境已配置完成"
        echo "Java版本: $(java -version 2>&1 | head -1)"
        echo "Maven版本: $(mvn -version 2>&1 | head -1)"
        ENVEOF
        
        chmod +x "$PACKAGE_DIR/setup-env.sh"
        
        # 创建README
        cat > "$PACKAGE_DIR/README.md" << 'READMEOF'
        # SDKMAN构建物 - Linux ARM64
        
        此构建物包含预配置的SDKMAN环境，内置：
        - JDK 21 (最新版本)
        - Maven (最新版本)
        
        ## 使用方法
        
        1. 解压构建物到目标目录
        2. 运行环境配置脚本：
           ```bash
           source ./setup-env.sh
           ```
        3. 验证安装：
           ```bash
           java -version
           mvn -version
           ```
        
        ## 目录结构
        
        ```
        sdkman-java21-maven-linux-arm64/
        ├── sdkman/                 # SDKMAN主目录
        ├── setup-env.sh            # 环境配置脚本
        └── README.md              # 本说明文件
        ```
        
        ## 版本信息
        
        构建时间: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        目标平台: Linux ARM64
        READMEOF
        
        # 创建版本信息文件
        cat > "$PACKAGE_DIR/version-info.txt" << 'VERSIONEOF'
        构建版本: ${GITHUB_RUN_NUMBER:-1}
        构建时间: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        Git提交: $(git rev-parse --short HEAD)
        目标平台: Linux ARM64
        Java版本: $(java -version 2>&1 | head -1)
        Maven版本: $(mvn -version 2>&1 | head -1)
        VERSIONEOF
        
        echo "打包完成，目录: $PACKAGE_DIR"
        EOF
        
        chmod +x ./scripts/package-artifact.sh
        
    - name: 在ARM64容器中构建SDKMAN构建物
      run: |
        docker run --rm \
          --platform linux/arm64 \
          -v $(pwd):/workspace \
          -w /workspace \
          ubuntu:22.04 \
          bash -c "
            set -e
            echo '在ARM64环境中开始构建...'
            
            # 更新系统并安装基础工具
            apt-get update
            apt-get install -y curl zip unzip tar wget git p7zip-full
            
            # 执行安装脚本
            ./scripts/install-sdkman.sh
            ./scripts/install-java-maven.sh
            ./scripts/package-artifact.sh
            
            echo 'ARM64构建物构建完成'
          "
          
    - name: 压缩构建物
      run: |
        cd ./build-artifact
        7z a "sdkman-java21-maven-linux-arm64-${{ github.run_number }}.7z" sdkman-java21-maven-linux-arm64/
        
        # 生成校验和
        sha256sum *.7z > checksums.txt
        
        ls -la
        
    - name: 上传构建物
      uses: actions/upload-artifact@v4
      with:
        name: sdkman-artifact-linux-arm64
        path: ./build-artifact/
        retention-days: 30
        
    - name: 创建发布信息
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "## 构建物信息" >> $GITHUB_STEP_SUMMARY
        echo "- 平台: Linux ARM64" >> $GITHUB_STEP_SUMMARY
        echo "- 包含: JDK21 + Maven (最新版本)" >> $GITHUB_STEP_SUMMARY
        echo "- 构建时间: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
        echo "- 构建号: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 下载的文件:" >> $GITHUB_STEP_SUMMARY
        ls -la ./build-artifact/ >> $GITHUB_STEP_SUMMARY
        
  security-scan:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: 下载构建物
      uses: actions/download-artifact@v4
      with:
        name: sdkman-artifact-linux-arm64
        path: ./downloaded-artifacts
        
    - name: 安全扫描
      run: |
        echo "进行安全扫描..."
        # 这里可以添加具体的安全扫描工具
        find ./downloaded-artifacts -name "*.tar.gz" -o -name "*.zip" | head -5
        
    - name: 生成安全报告
      run: |
        echo "## 安全扫描报告" >> $GITHUB_STEP_SUMMARY
        echo "- 扫描时间: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
        echo "- 扫描状态: 通过 (基础扫描)" >> $GITHUB_STEP_SUMMARY
        echo "- 建议: 在生产环境使用前请进行完整的安全审计" >> $GITHUB_STEP_SUMMARY